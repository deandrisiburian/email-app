<!DOCTYPE html>
<html lang="en"> 
  <head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>ZetaMail - Dashboard</title> 
    <link rel="stylesheet" href="css/style.css"> 
    <style> 
      .mail-container { 
        display: flex; 
        min-height: 100vh; 
      } 
      .sidebar { 
        width: 250px; 
        background: var(--dark-color); 
        color: #fff; padding: 1rem; 
      } 
      .sidebar ul { 
        list-style: none; 
        padding: 0; 
      } 
      .sidebar ul li { 
        margin-bottom: 1rem; 
      } 
      .sidebar ul li a { 
        color: #fff; 
        text-decoration: none; 
        display: block; 
        padding: 0.5rem; 
        border-radius: 5px; 
      } 
      .sidebar ul li a:hover, 
      .sidebar ul li a.active { 
        background: rgba(255,255,255,0.1); 
      } 
      .main-content { 
        flex: 1; 
        padding: 2rem; 
      } 
      .email-list { 
        border: 1px solid #ddd; 
        border-radius: 5px; 
        overflow: hidden; 
      } 
      .email-item { 
        padding: 1rem; 
        border-bottom: 1px solid #ddd; 
        cursor: pointer; 
      } 
      .email-item:hover { 
        background: #f5f5f5; 
      } 
      .email-item.unread { 
        font-weight: bold; 
      } 
      .compose-form { 
        background: #fff; 
        padding: 2rem; 
        border-radius: 10px; 
        box-shadow: 0 0 20px rgba(0,0,0,0.1); 
        margin-top: 2rem; 
      } 
      .form-control { 
        margin-bottom: 1rem; 
      } 
      .form-control label { 
        display: block; 
        margin-bottom: 0.5rem; 
      } 
      .form-control input, 
      .form-control textarea { 
        width: 100%; 
        padding: 0.75rem; 
        border: 1px solid #ccc; 
        border-radius: 5px; 
      } 
      .form-control textarea { 
        min-height: 200px; 
      } 
      .header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 1rem 2rem; 
        background: #fff; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
      } 
      .user-info { 
        display: flex; 
        align-items: center; 
        gap: 1rem; 
      } 
    </style> 
  </head> 
  <body> 
    <div class="header"> 
      <div class="logo">ZetaMail</div> 
      <div class="user-info"> 
        <span id="userEmail"></span> 
        <a href="index.html" class="btn">Sign Out</a> 
      </div> 
    </div>
    <div class="mail-container">
    <div class="sidebar">
        <ul>
            <li><a href="#" class="active" onclick="showInbox()">Inbox</a></li>
            <li><a href="#" onclick="showCompose()">Compose</a></li>
            <li><a href="#">Sent</a></li>
            <li><a href="#">Drafts</a></li>
            <li><a href="#">Trash</a></li>
        </ul>
    </div>
    <div class="main-content">
        <div id="inbox-view">
            <h2>Inbox</h2>
            <div class="email-list" id="email-list">
                <!-- Email list will be populated by JavaScript -->
            </div>
        </div>
        <div id="compose-view" style="display: none;">
            <h2>Compose Email</h2>
            <div class="compose-form">
                <form id="compose-form">
                    <div class="form-control">
                        <label for="to">To</label>
                        <input type="email" id="to" required>
                    </div>
                    <div class="form-control">
                        <label for="subject">Subject</label>
                        <input type="text" id="subject" required>
                    </div>
                    <div class="form-control">
                        <label for="body">Body</label>
                        <textarea id="body" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Include Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Supabase configuration
    const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
    
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Get user email from localStorage (set during login)
    const userEmail = localStorage.getItem('userEmail');
    if (!userEmail) {
        window.location.href = 'login.html';
    }
    document.getElementById('userEmail').textContent = userEmail;

    // Load inbox on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadInbox();
        setupRealtimeSubscription();
    });

    // Load inbox emails
    async function loadInbox() {
        const { data, error } = await supabase
            .from('emails')
            .select('*')
            .eq('receiver_email', userEmail)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading emails:', error);
            return;
        }

        displayEmails(data);
    }

    // Display emails in inbox
    function displayEmails(emails) {
        const emailList = document.getElementById('email-list');
        emailList.innerHTML = '';

        if (emails.length === 0) {
            emailList.innerHTML = '<div class="email-item">No emails found</div>';
            return;
        }

        emails.forEach(email => {
            const emailItem = document.createElement('div');
            emailItem.className = `email-item ${email.read ? '' : 'unread'}`;
            emailItem.innerHTML = `
                <div><strong>From:</strong> ${email.sender_email}</div>
                <div><strong>Subject:</strong> ${email.subject}</div>
                <div>${email.body.substring(0, 100)}...</div>
                <div><small>${new Date(email.created_at).toLocaleString()}</small></div>
            `;
            emailItem.addEventListener('click', () => {
                viewEmail(email);
            });
            emailList.appendChild(emailItem);
        });
    }

    // View email details
    function viewEmail(email) {
        // Mark as read
        markAsRead(email.id);
        
        // Show email content (you can implement a modal or separate view)
        alert(`From: ${email.sender_email}\nSubject: ${email.subject}\n\n${email.body}`);
    }

    // Mark email as read
    async function markAsRead(emailId) {
        await supabase
            .from('emails')
            .update({ read: true })
            .eq('id', emailId);
    }

    // Show compose view
    function showCompose() {
        document.getElementById('inbox-view').style.display = 'none';
        document.getElementById('compose-view').style.display = 'block';
    }

    // Show inbox view
    function showInbox() {
        document.getElementById('inbox-view').style.display = 'block';
        document.getElementById('compose-view').style.display = 'none';
        loadInbox();
    }

    // Handle compose form submission
    document.getElementById('compose-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const to = document.getElementById('to').value;
        const subject = document.getElementById('subject').value;
        const body = document.getElementById('body').value;

        // Send email
        const { data, error } = await supabase
            .from('emails')
            .insert([
                { 
                    sender_email: userEmail, 
                    receiver_email: to, 
                    subject: subject, 
                    body: body,
                    read: false
                }
            ]);

        if (error) {
            alert('Error sending email: ' + error.message);
        } else {
            alert('Email sent successfully!');
            document.getElementById('compose-form').reset();
            showInbox();
        }
    });

    // Real-time subscription for new emails
    function setupRealtimeSubscription() {
        supabase
            .channel('emails')
            .on('postgres_changes', 
                { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'emails',
                    filter: `receiver_email=eq.${userEmail}`
                }, 
                (payload) => {
                    // New email received
                    loadInbox();
                    showNotification('New email received from ' + payload.new.sender_email);
                }
            )
            .subscribe();
    }

    // Show notification for new email
    function showNotification(message) {
        // You can implement a more sophisticated notification system
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('ZetaMail - New Email', {
                body: message,
                icon: '/favicon.ico'
            });
        } else {
            // Fallback to alert
            alert('New email: ' + message);
        }
    }

    // Request notification permission
    if ('Notification' in window) {
        Notification.requestPermission();
    }
</script>
</body>
</html>
